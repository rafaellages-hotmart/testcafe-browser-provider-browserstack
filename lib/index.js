"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const url_1 = require("url");
const pinkie_1 = __importDefault(require("pinkie"));
const fs_1 = __importDefault(require("fs"));
const util_1 = require("util");
const desired_capabilities_1 = __importDefault(require("desired-capabilities"));
const lodash_1 = require("lodash");
const connector_1 = __importDefault(require("./connector"));
const js_testing_1 = __importDefault(require("./backends/js-testing"));
const automate_1 = __importDefault(require("./backends/automate"));
const browser_proxy_1 = __importDefault(require("./browser-proxy"));
const is_env_var_true_1 = __importDefault(require("./utils/is-env-var-true"));
const mime_db_1 = __importDefault(require("mime-db"));
const ANDROID_PROXY_RESPONSE_DELAY = 500;
const isAutomateEnabled = () => is_env_var_true_1.default('BROWSERSTACK_USE_AUTOMATE');
const isLocalEnabled = () => !!process.env.BROWSERSTACK_LOCAL_IDENTIFIER || !is_env_var_true_1.default('BROWSERSTACK_NO_LOCAL');
function getMimeTypes() {
    const mimeTypes = Object.keys(mime_db_1.default);
    return mimeTypes.filter(mimeType => {
        const { extensions } = mime_db_1.default[mimeType];
        return extensions && extensions.length;
    }).join(',');
}
module.exports = {
    // Multiple browsers support
    isMultiBrowser: true,
    backend: null,
    connectorPromise: pinkie_1.default.resolve(null),
    browserProxyPromise: pinkie_1.default.resolve(null),
    workers: {},
    platformsInfo: [],
    browserNames: [],
    _createConnector() {
        this.connectorPromise = this.connectorPromise
            .then(async (connector) => {
            if (!connector) {
                connector = new connector_1.default(process.env['BROWSERSTACK_ACCESS_KEY']);
                await connector.create();
            }
            return connector;
        });
        return this.connectorPromise;
    },
    _disposeConnector() {
        this.connectorPromise = this.connectorPromise
            .then(async (connector) => {
            if (connector)
                await connector.destroy();
            return null;
        });
        return this.connectorPromise;
    },
    _getBrowserProxy(host, port) {
        this.browserProxyPromise = this.browserProxyPromise
            .then(async (browserProxy) => {
            if (!browserProxy) {
                browserProxy = new browser_proxy_1.default(host, port, { responseDelay: ANDROID_PROXY_RESPONSE_DELAY });
                await browserProxy.init();
            }
            return browserProxy;
        });
        return this.browserProxyPromise;
    },
    _disposeBrowserProxy() {
        this.browserProxyPromise = this.browserProxyPromise
            .then(async (browserProxy) => {
            if (browserProxy)
                await browserProxy.dispose();
            return null;
        });
        return this.browserProxyPromise;
    },
    async _getDeviceList() {
        this.platformsInfo = await this.backend.getBrowsersList();
    },
    _createQuery(capabilities) {
        var { browserName, browserVersion, platform } = desired_capabilities_1.default(capabilities)[0];
        browserName = browserName.toLowerCase();
        if (browserName === 'internet explorer')
            browserName = 'ie';
        return {
            name: browserName,
            version: browserVersion.toLowerCase(),
            platform: platform.toLowerCase()
        };
    },
    _generateBasicCapabilities(browserName) {
        return this._filterPlatformInfo(this._createQuery(browserName))[0];
    },
    _getCapabilitiesFromEnvironment() {
        // NOTE: This function maps env vars to browserstack capabilities.
        // For the full list of capabilities, see https://www.browserstack.com/automate/capabilities
        return {
            'build': process.env['BROWSERSTACK_BUILD_ID'],
            'project': process.env['BROWSERSTACK_PROJECT_NAME'],
            'resolution': process.env['BROWSERSTACK_DISPLAY_RESOLUTION'],
            'name': process.env['BROWSERSTACK_TEST_RUN_NAME'],
            'browserstack.debug': process.env['BROWSERSTACK_DEBUG'],
            'browserstack.console': process.env['BROWSERSTACK_CONSOLE'],
            'browserstack.networkLogs': process.env['BROWSERSTACK_NETWORK_LOGS'],
            'browserstack.video': process.env['BROWSERSTACK_VIDEO'],
            'browserstack.timezone': process.env['BROWSERSTACK_TIMEZONE'],
            'browserstack.geoLocation': process.env['BROWSERSTACK_GEO_LOCATION'],
            'browserstack.customNetwork': process.env['BROWSERSTACK_CUSTOM_NETWORK'],
            'browserstack.networkProfile': process.env['BROWSERSTACK_NETWORK_PROFILE'],
            'acceptSslCerts': process.env['BROWSERSTACK_ACCEPT_SSL_CERTS']
        };
    },
    _getCapabilitiesFromConfig() {
        const defaultConfigPath = './browserstackConfig.js';
        const configPath = process.env.BROWSERSTACK_CAPABILITIES_CONFIG_PATH || defaultConfigPath;
        if (!fs_1.default.existsSync(configPath)) {
            if (configPath !== defaultConfigPath) {
                // eslint-disable-next-line
                console.warn('Could not find the file:', configPath);
            }
            return {};
        }
        return require(fs_1.default.realpathSync(configPath));
    },
    _getAdditionalCapabilities() {
        const capabilitiesFromEnvironment = lodash_1.pickBy(this._getCapabilitiesFromEnvironment(), value => value !== void 0);
        return Object.assign(Object.assign({}, this._getCapabilitiesFromConfig()), capabilitiesFromEnvironment);
    },
    _filterPlatformInfo(query) {
        return this.platformsInfo
            .filter(info => {
            var browserNameMatched = info['browser'] && info['browser'].toLowerCase() === query.name;
            var deviceNameMatched = info['device'] && info['device'].toLowerCase() === query.name;
            var browserVersionMatched = info['browser_version'] && Number(info['browser_version']) === Number(query.version);
            var platformVersionMatched = info['os_version'] && Number(info['os_version']) === Number(query.version);
            var platformNameMatched = info['os'].toLowerCase() === query.platform ||
                `${info['os'].toLowerCase()} ${info['os_version'].toLowerCase()}` === query.platform;
            var isAnyVersion = query.version === 'any';
            var isAnyPlatform = query.platform === 'any';
            var desktopBrowserMatched = browserNameMatched &&
                (browserVersionMatched || isAnyVersion) &&
                (platformNameMatched || isAnyPlatform);
            var mobileBrowserMatched = deviceNameMatched &&
                (platformVersionMatched || isAnyVersion);
            return desktopBrowserMatched || mobileBrowserMatched;
        });
    },
    _generateBrowserNames() {
        this.browserNames = this.platformsInfo
            .map(info => {
            var isDesktop = !info['device'];
            var name = isDesktop ? info['browser'] : info['device'];
            var version = isDesktop ? info['browser_version'] : info['os_version'];
            var platform = isDesktop ? `${info['os']} ${info['os_version']}` : '';
            return `${name}@${version}${platform ? ':' + platform : ''}`;
        });
    },
    _prepareChromeCapabilities(capabilities) {
        if (process.env['BROWSERSTACK_CHROME_ARGS'] && process.env['BROWSERSTACK_CHROME_ARGS'].length > 0)
            capabilities.chromeOptions = { args: [process.env['BROWSERSTACK_CHROME_ARGS']] };
    },
    async _prepareFirefoxCapabilities(capabilities) {
        if (!process.env['BROWSERSTACK_USE_AUTOMATE'])
            return;
        const FirefoxProfile = require('firefox-profile');
        const profile = new FirefoxProfile();
        profile.defaultPreferences = {};
        profile.setPreference('browser.helperApps.neverAsk.saveToDisk', getMimeTypes());
        profile.updatePreferences();
        capabilities['firefox_profile'] = await util_1.promisify(profile.encoded).bind(profile)();
    },
    async _encodeFirefoxProfile(profile) {
        return new pinkie_1.default((resolve, reject) => {
            profile.encoded(function (err, encodedProfile) {
                if (err)
                    reject(err);
                else
                    resolve(encodedProfile);
            });
        });
    },
    // Required - must be implemented
    // Browser control
    async openBrowser(id, pageUrl, browserName) {
        const capabilities = Object.assign(Object.assign({}, this._generateBasicCapabilities(browserName)), this._getAdditionalCapabilities());
        capabilities.local = isLocalEnabled();
        // Give preference to the already running local identifier
        capabilities.localIdentifier = process.env.BROWSERSTACK_LOCAL_IDENTIFIER;
        if (capabilities.local && !capabilities.localIdentifier) {
            const connector = await this._createConnector();
            capabilities.localIdentifier = connector.connectorInstance.localIdentifierFlag;
        }
        if (capabilities.os.toLowerCase() === 'android') {
            const parsedPageUrl = url_1.parse(pageUrl);
            const browserProxy = await this._getBrowserProxy(parsedPageUrl.hostname, parsedPageUrl.port);
            pageUrl = 'http://' + browserProxy.targetHost + ':' + browserProxy.proxyPort + parsedPageUrl.path;
        }
        if (!capabilities.name)
            capabilities.name = `TestCafe test run ${id}`;
        if (browserName.includes('chrome'))
            this._prepareChromeCapabilities(capabilities);
        if (browserName.includes('firefox'))
            await this._prepareFirefoxCapabilities(capabilities);
        await this.backend.openBrowser(id, pageUrl, capabilities);
        this.setUserAgentMetaInfo(id, this.backend.getSessionUrl(id));
    },
    async closeBrowser(id) {
        await this.backend.closeBrowser(id);
    },
    // Optional - implement methods you need, remove other methods
    // Initialization
    async init() {
        var reportWarning = (...args) => this.reportWarning(...args);
        this.backend = isAutomateEnabled() ? new automate_1.default(reportWarning) : new js_testing_1.default(reportWarning);
        await this._getDeviceList();
        this._generateBrowserNames();
    },
    async dispose() {
        await this._disposeConnector();
        await this._disposeBrowserProxy();
    },
    // Browser names handling
    async getBrowserList() {
        return this.browserNames;
    },
    async isValidBrowserName(browserName) {
        return desired_capabilities_1.default(browserName).length === 1 && !!this._filterPlatformInfo(this._createQuery(browserName)).length;
    },
    // Extra methods
    async resizeWindow(id, width, height, currentWidth, currentHeight) {
        await this.backend.resizeWindow(id, width, height, currentWidth, currentHeight);
    },
    async maximizeWindow(id) {
        await this.backend.maximizeWindow(id);
    },
    async takeScreenshot(id, screenshotPath) {
        await this.backend.takeScreenshot(id, screenshotPath);
    },
    async reportJobResult(id, jobResult, jobData) {
        await this.backend.reportJobResult(id, jobResult, jobData, this.JOB_RESULT);
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXguanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSw2QkFBd0M7QUFDeEMsb0RBQTZCO0FBQzdCLDRDQUFvQjtBQUNwQiwrQkFBaUM7QUFDakMsZ0ZBQXFEO0FBQ3JELG1DQUFnQztBQUNoQyw0REFBZ0Q7QUFDaEQsdUVBQXFEO0FBQ3JELG1FQUFrRDtBQUNsRCxvRUFBMkM7QUFDM0MsOEVBQW1EO0FBQ25ELHNEQUF5QjtBQUV6QixNQUFNLDRCQUE0QixHQUFHLEdBQUcsQ0FBQztBQUV6QyxNQUFNLGlCQUFpQixHQUFHLEdBQUcsRUFBRSxDQUFDLHlCQUFZLENBQUMsMkJBQTJCLENBQUMsQ0FBQztBQUMxRSxNQUFNLGNBQWMsR0FBTSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyw2QkFBNkIsSUFBSSxDQUFDLHlCQUFZLENBQUMsdUJBQXVCLENBQUMsQ0FBQztBQUV0SCxTQUFTLFlBQVk7SUFDakIsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxpQkFBRSxDQUFDLENBQUM7SUFFbEMsT0FBTyxTQUFTLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxFQUFFO1FBQy9CLE1BQU0sRUFBRSxVQUFVLEVBQUUsR0FBRyxpQkFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRXBDLE9BQU8sVUFBVSxJQUFJLFVBQVUsQ0FBQyxNQUFNLENBQUM7SUFDM0MsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ2pCLENBQUM7QUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHO0lBQ2IsNEJBQTRCO0lBQzVCLGNBQWMsRUFBRSxJQUFJO0lBRXBCLE9BQU8sRUFBRSxJQUFJO0lBRWIsZ0JBQWdCLEVBQUssZ0JBQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDO0lBQzFDLG1CQUFtQixFQUFFLGdCQUFPLENBQUMs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QUMsZUFBZSxDQUFDLEVBQUUsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNoRixDQUFDO0NBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHBhcnNlIGFzIHBhcnNlVXJsIH0gZnJvbSAndXJsJztcbmltcG9ydCBQcm9taXNlIGZyb20gJ3BpbmtpZSc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHsgcHJvbWlzaWZ5IH0gZnJvbSAndXRpbCc7XG5pbXBvcnQgcGFyc2VDYXBhYmlsaXRpZXMgZnJvbSAnZGVzaXJlZC1jYXBhYmlsaXRpZXMnO1xuaW1wb3J0IHsgcGlja0J5IH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBCcm93c2Vyc3RhY2tDb25uZWN0b3IgZnJvbSAnLi9jb25uZWN0b3InO1xuaW1wb3J0IEpTVGVzdGluZ0JhY2tlbmQgZnJvbSAnLi9iYWNrZW5kcy9qcy10ZXN0aW5nJztcbmltcG9ydCBBdXRvbWF0ZUJhY2tlbmQgZnJvbSAnLi9iYWNrZW5kcy9hdXRvbWF0ZSc7XG5pbXBvcnQgQnJvd3NlclByb3h5IGZyb20gJy4vYnJvd3Nlci1wcm94eSc7XG5pbXBvcnQgaXNFbnZWYXJUcnVlIGZyb20gJy4vdXRpbHMvaXMtZW52LXZhci10cnVlJztcbmltcG9ydCBkYiBmcm9tICdtaW1lLWRiJztcblxuY29uc3QgQU5EUk9JRF9QUk9YWV9SRVNQT05TRV9ERUxBWSA9IDUwMDtcblxuY29uc3QgaXNBdXRvbWF0ZUVuYWJsZWQgPSAoKSA9PiBpc0VudlZhclRydWUoJ0JST1dTRVJTVEFDS19VU0VfQVVUT01BVEUnKTtcbmNvbnN0IGlzTG9jYWxFbmFibGVkICAgID0gKCkgPT4gISFwcm9jZXNzLmVudi5CUk9XU0VSU1RBQ0tfTE9DQUxfSURFTlRJRklFUiB8fCAhaXNFbnZWYXJUcnVlKCdCUk9XU0VSU1RBQ0tfTk9fTE9DQUwnKTtcblxuZnVuY3Rpb24gZ2V0TWltZVR5cGVzICgpIHtcbiAgICBjb25zdCBtaW1lVHlwZXMgPSBPYmplY3Qua2V5cyhkYik7XG5cbiAgICByZXR1cm4gbWltZVR5cGVzLmZpbHRlcihtaW1lVHlwZSA9PiB7XG4gICAgICAgIGNvbnN0IHsgZXh0ZW5zaW9ucyB9ID0gZGJbbWltZVR5cGVdO1xuXG4gICAgICAgIHJldHVybiBleHRlbnNpb25zICYmIGV4dGVuc2lvbnMubGVuZ3RoO1xuICAgIH0pLmpvaW4oJywnKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gICAgLy8gTXVsdGlwbGUgYnJvd3NlcnMgc3VwcG9ydFxuICAgIGlzTXVsdGlCcm93c2VyOiB0cnVlLFxuXG4gICAgYmFja2VuZDogbnVsbCxcblxuICAgIGNvbm5lY3RvclByb21pc2U6ICAgIFByb21pc2UucmVzb2x2ZShudWxsKSxcbiAgICBicm93c2VyUHJveHlQcm9taXNlOiBQcm9taXNlLnJlc29sdmUobnVsbCksXG5cbiAgICB3b3JrZXJzOiAgICAgICB7fSxcbiAgICBwbGF0Zm9ybXNJbmZvOiBbXSxcbiAgICBicm93c2VyTmFtZXM6ICBbXSxcblxuICAgIF9jcmVhdGVDb25uZWN0b3IgKCkge1xuICAgICAgICB0aGlzLmNvbm5lY3RvclByb21pc2UgPSB0aGlzLmNvbm5lY3RvclByb21pc2VcbiAgICAgICAgICAgIC50aGVuKGFzeW5jIGNvbm5lY3RvciA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFjb25uZWN0b3IpIHtcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdG9yID0gbmV3IEJyb3dzZXJzdGFja0Nvbm5lY3Rvcihwcm9jZXNzLmVudlsnQlJPV1NFUlNUQUNLX0FDQ0VTU19LRVknXSk7XG5cbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgY29ubmVjdG9yLmNyZWF0ZSgpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiBjb25uZWN0b3I7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdGhpcy5jb25uZWN0b3JQcm9taXNlO1xuICAgIH0sXG5cbiAgICBfZGlzcG9zZUNvbm5lY3RvciAoKSB7XG4gICAgICAgIHRoaXMuY29ubmVjdG9yUHJvbWlzZSA9IHRoaXMuY29ubmVjdG9yUHJvbWlzZVxuICAgICAgICAgICAgLnRoZW4oYXN5bmMgY29ubmVjdG9yID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoY29ubmVjdG9yKVxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBjb25uZWN0b3IuZGVzdHJveSgpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdGhpcy5jb25uZWN0b3JQcm9taXNlO1xuICAgIH0sXG5cbiAgICBfZ2V0QnJvd3NlclByb3h5IChob3N0LCBwb3J0KSB7XG4gICAgICAgIHRoaXMuYnJvd3NlclByb3h5UHJvbWlzZSA9IHRoaXMuYnJvd3NlclByb3h5UHJvbWlzZVxuICAgICAgICAgICAgLnRoZW4oYXN5bmMgYnJvd3NlclByb3h5ID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIWJyb3dzZXJQcm94eSkge1xuICAgICAgICAgICAgICAgICAgICBicm93c2VyUHJveHkgPSBuZXcgQnJvd3NlclByb3h5KGhvc3QsIHBvcnQsIHsgcmVzcG9uc2VEZWxheTogQU5EUk9JRF9QUk9YWV9SRVNQT05TRV9ERUxBWSB9KTtcblxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBicm93c2VyUHJveHkuaW5pdCgpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiBicm93c2VyUHJveHk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdGhpcy5icm93c2VyUHJveHlQcm9taXNlO1xuICAgIH0sXG5cbiAgICBfZGlzcG9zZUJyb3dzZXJQcm94eSAoKSB7XG4gICAgICAgIHRoaXMuYnJvd3NlclByb3h5UHJvbWlzZSA9IHRoaXMuYnJvd3NlclByb3h5UHJvbWlzZVxuICAgICAgICAgICAgLnRoZW4oYXN5bmMgYnJvd3NlclByb3h5ID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoYnJvd3NlclByb3h5KVxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBicm93c2VyUHJveHkuZGlzcG9zZSgpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdGhpcy5icm93c2VyUHJveHlQcm9taXNlO1xuICAgIH0sXG5cbiAgICBhc3luYyBfZ2V0RGV2aWNlTGlzdCAoKSB7XG4gICAgICAgIHRoaXMucGxhdGZvcm1zSW5mbyA9IGF3YWl0IHRoaXMuYmFja2VuZC5nZXRCcm93c2Vyc0xpc3QoKTtcbiAgICB9LFxuXG4gICAgX2NyZWF0ZVF1ZXJ5IChjYXBhYmlsaXRpZXMpIHtcbiAgICAgICAgdmFyIHsgYnJvd3Nlck5hbWUsIGJyb3dzZXJWZXJzaW9uLCBwbGF0Zm9ybSB9ID0gcGFyc2VDYXBhYmlsaXRpZXMoY2FwYWJpbGl0aWVzKVswXTtcblxuICAgICAgICBicm93c2VyTmFtZSA9IGJyb3dzZXJOYW1lLnRvTG93ZXJDYXNlKCk7XG5cbiAgICAgICAgaWYgKGJyb3dzZXJOYW1lID09PSAnaW50ZXJuZXQgZXhwbG9yZXInKVxuICAgICAgICAgICAgYnJvd3Nlck5hbWUgPSAnaWUnO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBuYW1lOiAgICAgYnJvd3Nlck5hbWUsXG4gICAgICAgICAgICB2ZXJzaW9uOiAgYnJvd3NlclZlcnNpb24udG9Mb3dlckNhc2UoKSxcbiAgICAgICAgICAgIHBsYXRmb3JtOiBwbGF0Zm9ybS50b0xvd2VyQ2FzZSgpXG4gICAgICAgIH07XG4gICAgfSxcblxuICAgIF9nZW5lcmF0ZUJhc2ljQ2FwYWJpbGl0aWVzIChicm93c2VyTmFtZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZmlsdGVyUGxhdGZvcm1JbmZvKHRoaXMuX2NyZWF0ZVF1ZXJ5KGJyb3dzZXJOYW1lKSlbMF07XG4gICAgfSxcblxuICAgIF9nZXRDYXBhYmlsaXRpZXNGcm9tRW52aXJvbm1lbnQgKCkge1xuICAgICAgICAvLyBOT1RFOiBUaGlzIGZ1bmN0aW9uIG1hcHMgZW52IHZhcnMgdG8gYnJvd3NlcnN0YWNrIGNhcGFiaWxpdGllcy5cbiAgICAgICAgLy8gRm9yIHRoZSBmdWxsIGxpc3Qgb2YgY2FwYWJpbGl0aWVzLCBzZWUgaHR0cHM6Ly93d3cuYnJvd3NlcnN0YWNrLmNvbS9hdXRvbWF0ZS9jYXBhYmlsaXRpZXNcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgJ2J1aWxkJzogICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3MuZW52WydCUk9XU0VSU1RBQ0tfQlVJTERfSUQnXSxcbiAgICAgICAgICAgICdwcm9qZWN0JzogICAgICAgICAgICAgICAgICAgICBwcm9jZXNzLmVudlsnQlJPV1NFUlNUQUNLX1BST0pFQ1RfTkFNRSddLFxuICAgICAgICAgICAgJ3Jlc29sdXRpb24nOiAgICAgICAgICAgICAgICAgIHByb2Nlc3MuZW52WydCUk9XU0VSU1RBQ0tfRElTUExBWV9SRVNPTFVUSU9OJ10sXG4gICAgICAgICAgICAnbmFtZSc6ICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5lbnZbJ0JST1dTRVJTVEFDS19URVNUX1JVTl9OQU1FJ10sXG4gICAgICAgICAgICAnYnJvd3NlcnN0YWNrLmRlYnVnJzogICAgICAgICAgcHJvY2Vzcy5lbnZbJ0JST1dTRVJTVEFDS19ERUJVRyddLFxuICAgICAgICAgICAgJ2Jyb3dzZXJzdGFjay5jb25zb2xlJzogICAgICAgIHByb2Nlc3MuZW52WydCUk9XU0VSU1RBQ0tfQ09OU09MRSddLFxuICAgICAgICAgICAgJ2Jyb3dzZXJzdGFjay5uZXR3b3JrTG9ncyc6ICAgIHByb2Nlc3MuZW52WydCUk9XU0VSU1RBQ0tfTkVUV09SS19MT0dTJ10sXG4gICAgICAgICAgICAnYnJvd3NlcnN0YWNrLnZpZGVvJzogICAgICAgICAgcHJvY2Vzcy5lbnZbJ0JST1dTRVJTVEFDS19WSURFTyddLFxuICAgICAgICAgICAgJ2Jyb3dzZXJzdGFjay50aW1lem9uZSc6ICAgICAgIHByb2Nlc3MuZW52WydCUk9XU0VSU1RBQ0tfVElNRVpPTkUnXSxcbiAgICAgICAgICAgICdicm93c2Vyc3RhY2suZ2VvTG9jYXRpb24nOiAgICBwcm9jZXNzLmVudlsnQlJPV1NFUlNUQUNLX0dFT19MT0NBVElPTiddLFxuICAgICAgICAgICAgJ2Jyb3dzZXJzdGFjay5jdXN0b21OZXR3b3JrJzogIHByb2Nlc3MuZW52WydCUk9XU0VSU1RBQ0tfQ1VTVE9NX05FVFdPUksnXSxcbiAgICAgICAgICAgICdicm93c2Vyc3RhY2submV0d29ya1Byb2ZpbGUnOiBwcm9jZXNzLmVudlsnQlJPV1NFUlNUQUNLX05FVFdPUktfUFJPRklMRSddLFxuICAgICAgICAgICAgJ2FjY2VwdFNzbENlcnRzJzogICAgICAgICAgICAgIHByb2Nlc3MuZW52WydCUk9XU0VSU1RBQ0tfQUNDRVBUX1NTTF9DRVJUUyddXG4gICAgICAgIH07XG4gICAgfSxcblxuICAgIF9nZXRDYXBhYmlsaXRpZXNGcm9tQ29uZmlnICgpIHtcbiAgICAgICAgY29uc3QgZGVmYXVsdENvbmZpZ1BhdGggPSAnLi9icm93c2Vyc3RhY2tDb25maWcuanMnO1xuICAgICAgICBjb25zdCBjb25maWdQYXRoID0gcHJvY2Vzcy5lbnYuQlJPV1NFUlNUQUNLX0NBUEFCSUxJVElFU19DT05GSUdfUEFUSCB8fCBkZWZhdWx0Q29uZmlnUGF0aDtcblxuICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoY29uZmlnUGF0aCkpIHtcbiAgICAgICAgICAgIGlmIChjb25maWdQYXRoICE9PSBkZWZhdWx0Q29uZmlnUGF0aCkge1xuICAgICAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZVxuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignQ291bGQgbm90IGZpbmQgdGhlIGZpbGU6JywgY29uZmlnUGF0aCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4ge307XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlcXVpcmUoZnMucmVhbHBhdGhTeW5jKGNvbmZpZ1BhdGgpKTtcbiAgICB9LFxuXG4gICAgX2dldEFkZGl0aW9uYWxDYXBhYmlsaXRpZXMgKCkge1xuICAgICAgICBjb25zdCBjYXBhYmlsaXRpZXNGcm9tRW52aXJvbm1lbnQgPSBwaWNrQnkodGhpcy5fZ2V0Q2FwYWJpbGl0aWVzRnJvbUVudmlyb25tZW50KCksIHZhbHVlID0+IHZhbHVlICE9PSB2b2lkIDApO1xuXG4gICAgICAgIHJldHVybiB7IC4uLnRoaXMuX2dldENhcGFiaWxpdGllc0Zyb21Db25maWcoKSwgLi4uY2FwYWJpbGl0aWVzRnJvbUVudmlyb25tZW50IH07XG4gICAgfSxcblxuICAgIF9maWx0ZXJQbGF0Zm9ybUluZm8gKHF1ZXJ5KSB7XG4gICAgICAgIHJldHVybiB0aGlzLnBsYXRmb3Jtc0luZm9cbiAgICAgICAgICAgIC5maWx0ZXIoaW5mbyA9PiB7XG4gICAgICAgICAgICAgICAgdmFyIGJyb3dzZXJOYW1lTWF0Y2hlZCA9IGluZm9bJ2Jyb3dzZXInXSAmJiBpbmZvWydicm93c2VyJ10udG9Mb3dlckNhc2UoKSA9PT0gcXVlcnkubmFtZTtcbiAgICAgICAgICAgICAgICB2YXIgZGV2aWNlTmFtZU1hdGNoZWQgID0gaW5mb1snZGV2aWNlJ10gJiYgaW5mb1snZGV2aWNlJ10udG9Mb3dlckNhc2UoKSA9PT0gcXVlcnkubmFtZTtcblxuICAgICAgICAgICAgICAgIHZhciBicm93c2VyVmVyc2lvbk1hdGNoZWQgID0gaW5mb1snYnJvd3Nlcl92ZXJzaW9uJ10gJiYgTnVtYmVyKGluZm9bJ2Jyb3dzZXJfdmVyc2lvbiddKSA9PT0gTnVtYmVyKHF1ZXJ5LnZlcnNpb24pO1xuICAgICAgICAgICAgICAgIHZhciBwbGF0Zm9ybVZlcnNpb25NYXRjaGVkID0gaW5mb1snb3NfdmVyc2lvbiddICYmIE51bWJlcihpbmZvWydvc192ZXJzaW9uJ10pID09PSBOdW1iZXIocXVlcnkudmVyc2lvbik7XG4gICAgICAgICAgICAgICAgdmFyIHBsYXRmb3JtTmFtZU1hdGNoZWQgICAgPSBpbmZvWydvcyddLnRvTG93ZXJDYXNlKCkgPT09IHF1ZXJ5LnBsYXRmb3JtIHx8XG4gICAgICAgICAgICAgICAgICAgIGAke2luZm9bJ29zJ10udG9Mb3dlckNhc2UoKX0gJHtpbmZvWydvc192ZXJzaW9uJ10udG9Mb3dlckNhc2UoKX1gID09PSBxdWVyeS5wbGF0Zm9ybTtcblxuICAgICAgICAgICAgICAgIHZhciBpc0FueVZlcnNpb24gID0gcXVlcnkudmVyc2lvbiA9PT0gJ2FueSc7XG4gICAgICAgICAgICAgICAgdmFyIGlzQW55UGxhdGZvcm0gPSBxdWVyeS5wbGF0Zm9ybSA9PT0gJ2FueSc7XG5cbiAgICAgICAgICAgICAgICB2YXIgZGVza3RvcEJyb3dzZXJNYXRjaGVkID0gYnJvd3Nlck5hbWVNYXRjaGVkICYmXG4gICAgICAgICAgICAgICAgICAgIChicm93c2VyVmVyc2lvbk1hdGNoZWQgfHwgaXNBbnlWZXJzaW9uKSAmJlxuICAgICAgICAgICAgICAgICAgICAocGxhdGZvcm1OYW1lTWF0Y2hlZCB8fCBpc0FueVBsYXRmb3JtKTtcblxuICAgICAgICAgICAgICAgIHZhciBtb2JpbGVCcm93c2VyTWF0Y2hlZCA9IGRldmljZU5hbWVNYXRjaGVkICYmXG4gICAgICAgICAgICAgICAgICAgIChwbGF0Zm9ybVZlcnNpb25NYXRjaGVkIHx8IGlzQW55VmVyc2lvbik7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gZGVza3RvcEJyb3dzZXJNYXRjaGVkIHx8IG1vYmlsZUJyb3dzZXJNYXRjaGVkO1xuICAgICAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIF9nZW5lcmF0ZUJyb3dzZXJOYW1lcyAoKSB7XG4gICAgICAgIHRoaXMuYnJvd3Nlck5hbWVzID0gdGhpcy5wbGF0Zm9ybXNJbmZvXG4gICAgICAgICAgICAubWFwKGluZm8gPT4ge1xuICAgICAgICAgICAgICAgIHZhciBpc0Rlc2t0b3AgPSAhaW5mb1snZGV2aWNlJ107XG4gICAgICAgICAgICAgICAgdmFyIG5hbWUgICAgICA9IGlzRGVza3RvcCA/IGluZm9bJ2Jyb3dzZXInXSA6IGluZm9bJ2RldmljZSddO1xuICAgICAgICAgICAgICAgIHZhciB2ZXJzaW9uICAgPSBpc0Rlc2t0b3AgPyBpbmZvWydicm93c2VyX3ZlcnNpb24nXSA6IGluZm9bJ29zX3ZlcnNpb24nXTtcbiAgICAgICAgICAgICAgICB2YXIgcGxhdGZvcm0gID0gaXNEZXNrdG9wID8gYCR7aW5mb1snb3MnXX0gJHtpbmZvWydvc192ZXJzaW9uJ119YCA6ICcnO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGAke25hbWV9QCR7dmVyc2lvbn0ke3BsYXRmb3JtID8gJzonICsgcGxhdGZvcm0gOiAnJ31gO1xuICAgICAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIF9wcmVwYXJlQ2hyb21lQ2FwYWJpbGl0aWVzIChjYXBhYmlsaXRpZXMpIHtcbiAgICAgICAgaWYgKHByb2Nlc3MuZW52WydCUk9XU0VSU1RBQ0tfQ0hST01FX0FSR1MnXSAmJiBwcm9jZXNzLmVudlsnQlJPV1NFUlNUQUNLX0NIUk9NRV9BUkdTJ10ubGVuZ3RoID4gMClcbiAgICAgICAgICAgIGNhcGFiaWxpdGllcy5jaHJvbWVPcHRpb25zID0geyBhcmdzOiBbcHJvY2Vzcy5lbnZbJ0JST1dTRVJTVEFDS19DSFJPTUVfQVJHUyddXSB9O1xuICAgIH0sXG5cbiAgICBhc3luYyBfcHJlcGFyZUZpcmVmb3hDYXBhYmlsaXRpZXMgKGNhcGFiaWxpdGllcykge1xuICAgICAgICBpZiAoIXByb2Nlc3MuZW52WydCUk9XU0VSU1RBQ0tfVVNFX0FVVE9NQVRFJ10pXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgY29uc3QgRmlyZWZveFByb2ZpbGUgPSByZXF1aXJlKCdmaXJlZm94LXByb2ZpbGUnKTtcbiAgICAgICAgY29uc3QgcHJvZmlsZSAgICAgICAgPSBuZXcgRmlyZWZveFByb2ZpbGUoKTtcblxuICAgICAgICBwcm9maWxlLmRlZmF1bHRQcmVmZXJlbmNlcyA9IHt9O1xuXG4gICAgICAgIHByb2ZpbGUuc2V0UHJlZmVyZW5jZSgnYnJvd3Nlci5oZWxwZXJBcHBzLm5ldmVyQXNrLnNhdmVUb0Rpc2snLCBnZXRNaW1lVHlwZXMoKSk7XG4gICAgICAgIHByb2ZpbGUudXBkYXRlUHJlZmVyZW5jZXMoKTtcblxuICAgICAgICBjYXBhYmlsaXRpZXNbJ2ZpcmVmb3hfcHJvZmlsZSddID0gYXdhaXQgcHJvbWlzaWZ5KHByb2ZpbGUuZW5jb2RlZCkuYmluZChwcm9maWxlKSgpO1xuICAgIH0sXG5cbiAgICBhc3luYyBfZW5jb2RlRmlyZWZveFByb2ZpbGUgKHByb2ZpbGUpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHByb2ZpbGUuZW5jb2RlZChmdW5jdGlvbiAoZXJyLCBlbmNvZGVkUHJvZmlsZSkge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpXG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShlbmNvZGVkUHJvZmlsZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8vIFJlcXVpcmVkIC0gbXVzdCBiZSBpbXBsZW1lbnRlZFxuICAgIC8vIEJyb3dzZXIgY29udHJvbFxuICAgIGFzeW5jIG9wZW5Ccm93c2VyIChpZCwgcGFnZVVybCwgYnJvd3Nlck5hbWUpIHtcbiAgICAgICAgY29uc3QgY2FwYWJpbGl0aWVzID0ge1xuICAgICAgICAgICAgLi4udGhpcy5fZ2VuZXJhdGVCYXNpY0NhcGFiaWxpdGllcyhicm93c2VyTmFtZSksXG4gICAgICAgICAgICAuLi50aGlzLl9nZXRBZGRpdGlvbmFsQ2FwYWJpbGl0aWVzKClcbiAgICAgICAgfTtcblxuICAgICAgICBjYXBhYmlsaXRpZXMubG9jYWwgICAgICAgICAgID0gaXNMb2NhbEVuYWJsZWQoKTtcblxuICAgICAgICAvLyBHaXZlIHByZWZlcmVuY2UgdG8gdGhlIGFscmVhZHkgcnVubmluZyBsb2NhbCBpZGVudGlmaWVyXG4gICAgICAgIGNhcGFiaWxpdGllcy5sb2NhbElkZW50aWZpZXIgPSBwcm9jZXNzLmVudi5CUk9XU0VSU1RBQ0tfTE9DQUxfSURFTlRJRklFUjtcblxuICAgICAgICBpZiAoY2FwYWJpbGl0aWVzLmxvY2FsICYmICFjYXBhYmlsaXRpZXMubG9jYWxJZGVudGlmaWVyKSB7XG4gICAgICAgICAgICBjb25zdCBjb25uZWN0b3IgPSBhd2FpdCB0aGlzLl9jcmVhdGVDb25uZWN0b3IoKTtcblxuICAgICAgICAgICAgY2FwYWJpbGl0aWVzLmxvY2FsSWRlbnRpZmllciA9IGNvbm5lY3Rvci5jb25uZWN0b3JJbnN0YW5jZS5sb2NhbElkZW50aWZpZXJGbGFnO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNhcGFiaWxpdGllcy5vcy50b0xvd2VyQ2FzZSgpID09PSAnYW5kcm9pZCcpIHtcbiAgICAgICAgICAgIGNvbnN0IHBhcnNlZFBhZ2VVcmwgPSBwYXJzZVVybChwYWdlVXJsKTtcbiAgICAgICAgICAgIGNvbnN0IGJyb3dzZXJQcm94eSAgPSBhd2FpdCB0aGlzLl9nZXRCcm93c2VyUHJveHkocGFyc2VkUGFnZVVybC5ob3N0bmFtZSwgcGFyc2VkUGFnZVVybC5wb3J0KTtcblxuICAgICAgICAgICAgcGFnZVVybCA9ICdodHRwOi8vJyArIGJyb3dzZXJQcm94eS50YXJnZXRIb3N0ICsgJzonICsgYnJvd3NlclByb3h5LnByb3h5UG9ydCArIHBhcnNlZFBhZ2VVcmwucGF0aDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghY2FwYWJpbGl0aWVzLm5hbWUpXG4gICAgICAgICAgICBjYXBhYmlsaXRpZXMubmFtZSA9IGBUZXN0Q2FmZSB0ZXN0IHJ1biAke2lkfWA7XG5cbiAgICAgICAgaWYgKGJyb3dzZXJOYW1lLmluY2x1ZGVzKCdjaHJvbWUnKSlcbiAgICAgICAgICAgIHRoaXMuX3ByZXBhcmVDaHJvbWVDYXBhYmlsaXRpZXMoY2FwYWJpbGl0aWVzKTtcblxuICAgICAgICBpZiAoYnJvd3Nlck5hbWUuaW5jbHVkZXMoJ2ZpcmVmb3gnKSlcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX3ByZXBhcmVGaXJlZm94Q2FwYWJpbGl0aWVzKGNhcGFiaWxpdGllcyk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5iYWNrZW5kLm9wZW5Ccm93c2VyKGlkLCBwYWdlVXJsLCBjYXBhYmlsaXRpZXMpO1xuXG4gICAgICAgIHRoaXMuc2V0VXNlckFnZW50TWV0YUluZm8oaWQsIHRoaXMuYmFja2VuZC5nZXRTZXNzaW9uVXJsKGlkKSk7XG4gICAgfSxcblxuICAgIGFzeW5jIGNsb3NlQnJvd3NlciAoaWQpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5iYWNrZW5kLmNsb3NlQnJvd3NlcihpZCk7XG4gICAgfSxcblxuICAgIC8vIE9wdGlvbmFsIC0gaW1wbGVtZW50IG1ldGhvZHMgeW91IG5lZWQsIHJlbW92ZSBvdGhlciBtZXRob2RzXG4gICAgLy8gSW5pdGlhbGl6YXRpb25cbiAgICBhc3luYyBpbml0ICgpIHtcbiAgICAgICAgdmFyIHJlcG9ydFdhcm5pbmcgPSAoLi4uYXJncykgPT4gdGhpcy5yZXBvcnRXYXJuaW5nKC4uLmFyZ3MpO1xuXG4gICAgICAgIHRoaXMuYmFja2VuZCA9IGlzQXV0b21hdGVFbmFibGVkKCkgPyBuZXcgQXV0b21hdGVCYWNrZW5kKHJlcG9ydFdhcm5pbmcpIDogbmV3IEpTVGVzdGluZ0JhY2tlbmQocmVwb3J0V2FybmluZyk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5fZ2V0RGV2aWNlTGlzdCgpO1xuXG4gICAgICAgIHRoaXMuX2dlbmVyYXRlQnJvd3Nlck5hbWVzKCk7XG4gICAgfSxcblxuICAgIGFzeW5jIGRpc3Bvc2UgKCkge1xuICAgICAgICBhd2FpdCB0aGlzLl9kaXNwb3NlQ29ubmVjdG9yKCk7XG4gICAgICAgIGF3YWl0IHRoaXMuX2Rpc3Bvc2VCcm93c2VyUHJveHkoKTtcbiAgICB9LFxuXG5cbiAgICAvLyBCcm93c2VyIG5hbWVzIGhhbmRsaW5nXG4gICAgYXN5bmMgZ2V0QnJvd3Nlckxpc3QgKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5icm93c2VyTmFtZXM7XG4gICAgfSxcblxuICAgIGFzeW5jIGlzVmFsaWRCcm93c2VyTmFtZSAoYnJvd3Nlck5hbWUpIHtcbiAgICAgICAgcmV0dXJuIHBhcnNlQ2FwYWJpbGl0aWVzKGJyb3dzZXJOYW1lKS5sZW5ndGggPT09IDEgJiYgISF0aGlzLl9maWx0ZXJQbGF0Zm9ybUluZm8odGhpcy5fY3JlYXRlUXVlcnkoYnJvd3Nlck5hbWUpKS5sZW5ndGg7XG4gICAgfSxcblxuXG4gICAgLy8gRXh0cmEgbWV0aG9kc1xuICAgIGFzeW5jIHJlc2l6ZVdpbmRvdyAoaWQsIHdpZHRoLCBoZWlnaHQsIGN1cnJlbnRXaWR0aCwgY3VycmVudEhlaWdodCkge1xuICAgICAgICBhd2FpdCB0aGlzLmJhY2tlbmQucmVzaXplV2luZG93KGlkLCB3aWR0aCwgaGVpZ2h0LCBjdXJyZW50V2lkdGgsIGN1cnJlbnRIZWlnaHQpO1xuICAgIH0sXG5cbiAgICBhc3luYyBtYXhpbWl6ZVdpbmRvdyAoaWQpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5iYWNrZW5kLm1heGltaXplV2luZG93KGlkKTtcbiAgICB9LFxuXG5cbiAgICBhc3luYyB0YWtlU2NyZWVuc2hvdCAoaWQsIHNjcmVlbnNob3RQYXRoKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuYmFja2VuZC50YWtlU2NyZWVuc2hvdChpZCwgc2NyZWVuc2hvdFBhdGgpO1xuICAgIH0sXG5cbiAgICBhc3luYyByZXBvcnRKb2JSZXN1bHQgKGlkLCBqb2JSZXN1bHQsIGpvYkRhdGEpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5iYWNrZW5kLnJlcG9ydEpvYlJlc3VsdChpZCwgam9iUmVzdWx0LCBqb2JEYXRhLCB0aGlzLkpPQl9SRVNVTFQpO1xuICAgIH1cbn07XG4iXX0=