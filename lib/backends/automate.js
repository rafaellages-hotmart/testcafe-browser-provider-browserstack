"use strict";
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
                t[p[i]] = s[p[i]];
        }
    return t;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("util");
const jimp_1 = __importDefault(require("jimp"));
const base_1 = __importDefault(require("./base"));
const request_api_1 = __importDefault(require("../utils/request-api"));
const create_browserstack_status_1 = __importDefault(require("../utils/create-browserstack-status"));
const get_api_polling_interval_1 = __importDefault(require("../utils/get-api-polling-interval"));
const ERROR_MESSAGES = __importStar(require("../templates/error-messages"));
const API_POLLING_INTERVAL = get_api_polling_interval_1.default();
const BROWSERSTACK_API_PATHS = {
    browserList: {
        url: 'https://api.browserstack.com/automate/browsers.json'
    },
    newSession: {
        url: 'https://hub-cloud.browserstack.com/wd/hub/session',
        method: 'POST'
    },
    openUrl: id => ({
        url: `https://hub-cloud.browserstack.com/wd/hub/session/${id}/url`,
        method: 'POST'
    }),
    getWindowSize: id => ({
        url: `https://hub-cloud.browserstack.com/wd/hub/session/${id}/window/current/size`
    }),
    setWindowSize: id => ({
        url: `https://hub-cloud.browserstack.com/wd/hub/session/${id}/window/current/size`,
        method: 'POST'
    }),
    maximizeWindow: id => ({
        url: `https://hub-cloud.browserstack.com/wd/hub/session/${id}/window/current/maximize`,
        method: 'POST'
    }),
    getUrl: id => ({
        url: `https://hub-cloud.browserstack.com/wd/hub/session/${id}/url`
    }),
    deleteSession: id => ({
        url: `https://hub-cloud.browserstack.com/wd/hub/session/${id}`,
        method: 'DELETE'
    }),
    screenshot: id => ({
        url: `https://hub-cloud.browserstack.com/wd/hub/session/${id}/screenshot`
    }),
    getStatus: id => ({
        url: `https://api.browserstack.com/automate/sessions/${id}.json`
    }),
    setStatus: id => ({
        url: `https://api.browserstack.com/automate/sessions/${id}.json`,
        method: 'PUT'
    })
};
function requestApi(path, params) {
    return request_api_1.default(path, params)
        .then(response => {
        if (response.status) {
            throw new Error(ERROR_MESSAGES.REMOTE_API_REQUEST_FAILED({
                status: response.status,
                apiResponse: response.value && response.value.message || util_1.inspect(response)
            }));
        }
        return response;
    });
}
function getCorrectedSize(currentClientAreaSize, currentWindowSize, requestedSize) {
    var horizontalChrome = currentWindowSize.width - currentClientAreaSize.width;
    var verticalChrome = currentWindowSize.height - currentClientAreaSize.height;
    return {
        width: requestedSize.width + horizontalChrome,
        height: requestedSize.height + verticalChrome
    };
}
class AutomateBackend extends base_1.default {
    constructor(...args) {
        super(...args);
        this.sessions = {};
    }
    static _ensureSessionId(sessionInfo) {
        const sessionData = sessionInfo.value || {};
        const sessionCapabilities = sessionData.capabilities || {};
        sessionInfo.sessionId = sessionInfo.sessionId ||
            sessionData.sessionId ||
            sessionData['webdriver.remote.sessionid'] ||
            sessionCapabilities['webdriver.remote.sessionid'];
        if (!sessionInfo.sessionId) {
            throw new Error(ERROR_MESSAGES.SESSION_ID_NOT_FOUND({
                sessionInfoDump: util_1.inspect(sessionInfo)
            }));
        }
    }
    async _requestSessionUrl(id) {
        var sessionInfo = await request_api_1.default(BROWSERSTACK_API_PATHS.getStatus(this.sessions[id].sessionId));
        return sessionInfo['automation_session']['browser_url'];
    }
    async _requestCurrentWindowSize(id) {
        var currentWindowSizeData = await requestApi(BROWSERSTACK_API_PATHS.getWindowSize(this.sessions[id].sessionId));
        return {
            width: currentWindowSizeData.value.width,
            height: currentWindowSizeData.value.height
        };
    }
    async getBrowsersList() {
        var platformsInfo = await request_api_1.default(BROWSERSTACK_API_PATHS.browserList);
        return platformsInfo.reverse();
    }
    getSessionUrl(id) {
        return this.sessions[id] ? this.sessions[id].sessionUrl : '';
    }
    async openBrowser(id, pageUrl, capabilities) {
        var { localIdentifier, local } = capabilities, restCapabilities = __rest(capabilities, ["localIdentifier", "local"]);
        capabilities = Object.assign({ 'browserstack.localIdentifier': localIdentifier, 'browserstack.local': local }, restCapabilities);
        this.sessions[id] = await requestApi(BROWSERSTACK_API_PATHS.newSession, {
            body: { desiredCapabilities: capabilities },
            executeImmediately: true
        });
        AutomateBackend._ensureSessionId(this.sessions[id]);
        this.sessions[id].sessionUrl = await this._requestSessionUrl(id);
        var sessionId = this.sessions[id].sessionId;
        this.sessions[id].interval = setInterval(() => requestApi(BROWSERSTACK_API_PATHS.getUrl(sessionId), { executeImmediately: true }), API_POLLING_INTERVAL);
        await requestApi(BROWSERSTACK_API_PATHS.openUrl(sessionId), { body: { url: pageUrl } });
    }
    async closeBrowser(id) {
        const session = this.sessions[id];
        if (!session)
            return;
        clearInterval(session.interval);
        delete this.sessions[id];
        // Delete session whose sessionId is created
        if (session.sessionId && session.sessionId !== '')
            await requestApi(BROWSERSTACK_API_PATHS.deleteSession(session.sessionId));
    }
    async takeScreenshot(id, screenshotPath) {
        var base64Data = await requestApi(BROWSERSTACK_API_PATHS.screenshot(this.sessions[id].sessionId));
        var buffer = Buffer.from(base64Data.value, 'base64');
        const image = await jimp_1.default.read(buffer);
        await image.write(screenshotPath);
    }
    async resizeWindow(id, width, height, currentWidth, currentHeight) {
        var sessionId = this.sessions[id].sessionId;
        var currentWindowSize = await this._requestCurrentWindowSize(id);
        var currentClientAreaSize = { width: currentWidth, height: currentHeight };
        var requestedSize = { width, height };
        var correctedSize = getCorrectedSize(currentClientAreaSize, currentWindowSize, requestedSize);
        await requestApi(BROWSERSTACK_API_PATHS.setWindowSize(sessionId), { body: correctedSize });
    }
    async maximizeWindow(id) {
        await requestApi(BROWSERSTACK_API_PATHS.maximizeWindow(this.sessions[id].sessionId));
    }
    async reportJobResult(id, jobResult, jobData, possibleResults) {
        var sessionId = this.sessions[id].sessionId;
        var jobStatus = create_browserstack_status_1.default(jobResult, jobData, possibleResults);
        await request_api_1.default(BROWSERSTACK_API_PATHS.setStatus(sessionId), { body: jobStatus });
    }
}
exports.default = AutomateBackend;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0b21hdGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYmFja2VuZHMvYXV0b21hdGUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwrQkFBK0I7QUFDL0IsZ0RBQXdCO0FBQ3hCLGtEQUFpQztBQUNqQyx1RUFBa0Q7QUFDbEQscUdBQTJFO0FBQzNFLGlHQUFzRTtBQUN0RSw0RUFBOEQ7QUFHOUQsTUFBTSxvQkFBb0IsR0FBRyxrQ0FBcUIsRUFBRSxDQUFDO0FBRXJELE1BQU0sc0JBQXNCLEdBQUc7SUFDM0IsV0FBVyxFQUFFO1FBQ1QsR0FBRyxFQUFFLHFEQUFxRDtLQUM3RDtJQUVELFVBQVUsRUFBRTtRQUNSLEdBQUcsRUFBSyxtREFBbUQ7UUFDM0QsTUFBTSxFQUFFLE1BQU07S0FDakI7SUFFRCxPQUFPLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ1osR0FBRyxFQUFLLHFEQUFxRCxFQUFFLE1BQU07UUFDckUsTUFBTSxFQUFFLE1BQU07S0FDakIsQ0FBQztJQUVGLGFBQWEsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDbEIsR0FBRyxFQUFFLHFEQUFxRCxFQUFFLHNCQUFzQjtLQUNyRixDQUFDO0lBRUYsYUFBYSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNsQixHQUFHLEVBQUsscURBQXFELEVBQUUsc0JBQXNCO1FBQ3JGLE1BQU0sRUFBRSxNQUFNO0tBQ2pCLENBQUM7SUFFRixjQUFjLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ25CLEdBQUcsRUFBSyxxREFBcUQsRUFBRSwwQkFBMEI7UUFDekYsTUFBTSxFQUFFLE1BQU07S0FDakIsQ0FBQztJQUVGLE1BQU0sRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDWCxHQUFHLEVBQUUscURBQXFELEVBQUUsTUFBTTtLQUNyRSxDQUFDO0lBRUYsYUFBYSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNsQixHQUFHLEVBQUsscURBQXFELEVBQUUsRUFBRTtRQUNqRSxNQUFNLEVBQUUsUUFBUTtLQUNuQixDQUFDO0lBRUYsVUFBVSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNmLEdBQUcsRUFBRSxxREFBcUQsRUFBRSxhQUFhO0tBQzVFLENBQUM7SUFFRixTQUFTLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2QsR0FBRyxFQUFFLGtEQUFrRCxFQUFFLE9BQU87S0FDbkUsQ0FBQztJQUVGLFNBQVMsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDZCxHQUFHLEVBQUssa0RBQWtELEVBQUUsT0FBTztRQUNuRSxNQUFNLEVBQUUsS0FBSztLQUNoQixDQUFDO0NBQ0wsQ0FBQztBQUdGLFNBQVMsVUFBVSxDQUFFLElBQUksRUFBRSxNQUFNO0lBQzdCLE9BQU8scUJBQWMsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDO1NBQzlCLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRTtRQUNiLElBQUksUUFBUSxDQUFDLE1BQU0sRUFBRTtZQUNqQixNQUFNLElBQUksS0FBSyxDQUFDLGNBQWMsQ0FBQyx5QkFBeUIsQ0FBQztnQkFDckQsTUFBTSxFQUFPLFFBQVEsQ0FBQyxNQUFNO2dCQUM1QixXQUFXLEVBQUUsUUFBUSxDQUFDLEtBQUssSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLE9BQU8sSUFBSSxjQUFPLENBQUMsUUFBUSxDQUFDO2FBQzdFLENBQUMsQ0FBQyxDQUFDO1NBQ1A7UUFFRCxPQUFPLFFBQVEsQ0FBQztJQUNwQixDQUFDLENBQUMsQ0FBQztBQUNYLENBQUM7QUFFRCxTQUFTLGdCQUFnQixDQUFFLHFCQUFxQixFQUFFLGlCQUFpQixFQUFFLGFBQWE7SUFDOUUsSUFBSSxnQkFBZ0IsR0FBRyxpQkFBaUIsQ0FBQyxLQUFLLEdBQUcscUJBQXFCLENBQUMsS0FBSyxDQUFDO0lBQzdFLElBQUksY0FBYyxHQUFLLGlCQUFpQixDQUFDLE1BQU0sR0FBRyxxQkFBcUIsQ0FBQyxNQUFNLENBQUM7SUFFL0UsT0FBTztRQUNILEtBQUssRUFBRyxhQUFhLENBQUMsS0FBSyxHQUFHLGdCQUFnQjtRQUM5QyxNQUFNLEVBQUUsYUFBYSxDQUFDLE1BQU0sR0FBRyxjQUFjO0tBQ2hELENBQUM7QUFDTixDQUFDO0FBRUQsTUFBcUIsZUFBZ0IsU0FBUSxjQUFXO0lBQ3BELFlBQWEsR0FBRyxJQUFJO1FBQ2hCLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO1FBRWYsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7SUFDdkIsQ0FBQztJQUVELE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBRSxXQUFXO1FBQ2hDLE1BQU0sV0FBVyxHQUFXLFdBQVcsQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDO1FBQ3BELE1BQU0sbUJBQW1CLEdBQUcsV0FBVyxDQUFDLFlBQVksSUFBSSxFQUFFLENBQUM7UUFFM0QsV0FBVyxDQUFDLFNBQVMsR0FBRyxXQUFXLENBQUMsU0FBUztZQUNyQixXQUFXLENBQUMsU0FBUztZQUNyQixXQUFXLENBQUMsNEJBQTRCLENBQUM7WUFDekMsbUJBQW1CLENBQUMsNEJBQTRCLENBQUMsQ0FBQztRQUUxRSxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRTtZQUN4QixNQUFNLElBQUksS0FBSyxDQUFDLGNBQWMsQ0FBQyxvQkFBb0IsQ0FBQztnQkFDaEQsZUFBZSxFQUFFLGNBQU8sQ0FBQyxXQUFXLENBQUM7YUFDeEMsQ0FBQyxDQUFDLENBQUM7U0FDUDtJQUNMLENBQUM7SUFFRCxLQUFLLENBQUMsa0JBQWtCLENBQUUsRUFBRTtRQUN4QixJQUFJLFdBQVcsR0FBRyxNQUFNLHFCQUFjLENBQUMsc0JBQXNCLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztRQUV0RyxPQUFPLFdBQVcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQzVELENBQUM7SUFFRCxLQUFLLENBQUMseUJBQXlCLENBQUUsRUFBRTtRQUMvQixJQUFJLHFCQUFxQixHQUFHLE1BQU0sVUFBVSxDQUFDLHNCQUFzQixDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFFaEgsT0FBTztZQUNILEtBQUssRUFBRyxxQkFBcUIsQ0FBQyxLQUFLLENBQUMsS0FBSztZQUN6QyxNQUFNLEVBQUUscUJBQXFCLENBQUMsS0FBSyxDQUFDLE1BQU07U0FDN0MsQ0FBQztJQUNOLENBQUM7SUFFRCxLQUFLLENBQUMsZUFBZTtRQUNqQixJQUFJLGFBQWEsR0FBRyxNQUFNLHFCQUFjLENBQUMsc0JBQXNCLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFN0UsT0FBTyxhQUFhLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDbkMsQ0FBQztJQUVELGFBQWEsQ0FBRSxFQUFFO1FBQ2IsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQ2pFLENBQUM7SUFFRCxLQUFLLENBQUMsV0FBVyxDQUFFLEVBQUUsRUFBRSxPQUFPLEVBQUUsWUFBWTtRQUN4QyxJQUFJLEVBQUUsZUFBZSxFQUFFLEtBQUssS0FBMEIsWUFBWSxFQUFwQyxxRUFBb0MsQ0FBQztRQUVuRSxZQUFZLG1CQUNSLDhCQUE4QixFQUFFLGVBQWUsRUFDL0Msb0JBQW9CLEVBQVksS0FBSyxJQUNsQyxnQkFBZ0IsQ0FDdEIsQ0FBQztRQUVGLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxVQUFVLENBQUMsc0JBQXNCLENBQUMsVUFBVSxFQUFFO1lBQ3BFLElBQUksRUFBRSxFQUFFLG1CQUFtQixFQUFFLFlBQVksRUFBRTtZQUUzQyxrQkFBa0IsRUFBRSxJQUFJO1NBQzNCLENBQUMsQ0FBQztRQUVILGVBQWUsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFFcEQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxVQUFVLEdBQUcsTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFakUsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFFNUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxRQUFRLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFDLFVBQVUsQ0FBQyxzQkFBc0IsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLEVBQUUsRUFBRSxrQkFBa0IsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLG9CQUFvQixDQUFDLENBQUM7UUFFekosTUFBTSxVQUFVLENBQUMsc0JBQXNCLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQztJQUM1RixDQUFDO0lBRUQsS0FBSyxDQUFDLFlBQVksQ0FBRSxFQUFFO1FBQ2xCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFbEMsSUFBSSxDQUFDLE9BQU87WUFDUixPQUFPO1FBRVgsYUFBYSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUVoQyxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFekIsNENBQTRDO1FBQzVDLElBQUksT0FBTyxDQUFDLFNBQVMsSUFBSSxPQUFPLENBQUMsU0FBUyxLQUFLLEVBQUU7WUFDN0MsTUFBTSxVQUFVLENBQUMsc0JBQXNCLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO0lBQ2xGLENBQUM7SUFFRCxLQUFLLENBQUMsY0FBYyxDQUFFLEVBQUUsRUFBRSxjQUFjO1FBQ3BDLElBQUksVUFBVSxHQUFHLE1BQU0sVUFBVSxDQUFDLHNCQUFzQixDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDbEcsSUFBSSxNQUFNLEdBQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBRXpELE1BQU0sS0FBSyxHQUFHLE1BQU0sY0FBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUV0QyxNQUFNLEtBQUssQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDdEMsQ0FBQztJQUVELEtBQUssQ0FBQyxZQUFZLENBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLGFBQWE7UUFDOUQsSUFBSSxTQUFTLEdBQWUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFDeEQsSUFBSSxpQkFBaUIsR0FBTyxNQUFNLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNyRSxJQUFJLHFCQUFxQixHQUFHLEVBQUUsS0FBSyxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQUUsYUFBYSxFQUFFLENBQUM7UUFDM0UsSUFBSSxhQUFhLEdBQVcsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLENBQUM7UUFDOUMsSUFBSSxhQUFhLEdBQVcsZ0JBQWdCLENBQUMscUJBQXFCLEVBQUUsaUJBQWlCLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFFdEcsTUFBTSxVQUFVLENBQUMsc0JBQXNCLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLGFBQWEsRUFBRSxDQUFDLENBQUM7SUFDL0YsQ0FBQztJQUVELEtBQUssQ0FBQyxjQUFjLENBQUUsRUFBRTtRQUNwQixNQUFNLFVBQVUsQ0FBQyxzQkFBc0IsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO0lBQ3pGLENBQUM7SUFFRCxLQUFLLENBQUMsZUFBZSxDQUFFLEVBQUUsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLGVBQWU7UUFDMUQsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFDNUMsSUFBSSxTQUFTLEdBQUcsb0NBQXdCLENBQUMsU0FBUyxFQUFFLE9BQU8sRUFBRSxlQUFlLENBQUMsQ0FBQztRQUU5RSxNQUFNLHFCQUFjLENBQUMsc0JBQXNCLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUM7SUFDM0YsQ0FBQztDQUNKO0FBdEhELGtDQXNIQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGluc3BlY3QgfSBmcm9tICd1dGlsJztcbmltcG9ydCBqaW1wIGZyb20gJ2ppbXAnO1xuaW1wb3J0IEJhc2VCYWNrZW5kIGZyb20gJy4vYmFzZSc7XG5pbXBvcnQgcmVxdWVzdEFwaUJhc2UgZnJvbSAnLi4vdXRpbHMvcmVxdWVzdC1hcGknO1xuaW1wb3J0IGNyZWF0ZUJyb3dzZXJzdGFja1N0YXR1cyBmcm9tICcuLi91dGlscy9jcmVhdGUtYnJvd3NlcnN0YWNrLXN0YXR1cyc7XG5pbXBvcnQgZ2V0QVBJUG9sbGluZ0ludGVydmFsIGZyb20gJy4uL3V0aWxzL2dldC1hcGktcG9sbGluZy1pbnRlcnZhbCc7XG5pbXBvcnQgKiBhcyBFUlJPUl9NRVNTQUdFUyBmcm9tICcuLi90ZW1wbGF0ZXMvZXJyb3ItbWVzc2FnZXMnO1xuXG5cbmNvbnN0IEFQSV9QT0xMSU5HX0lOVEVSVkFMID0gZ2V0QVBJUG9sbGluZ0ludGVydmFsKCk7XG5cbmNvbnN0IEJST1dTRVJTVEFDS19BUElfUEFUSFMgPSB7XG4gICAgYnJvd3Nlckxpc3Q6IHtcbiAgICAgICAgdXJsOiAnaHR0cHM6Ly9hcGkuYnJvd3NlcnN0YWNrLmNvbS9hdXRvbWF0ZS9icm93c2Vycy5qc29uJ1xuICAgIH0sXG5cbiAgICBuZXdTZXNzaW9uOiB7XG4gICAgICAgIHVybDogICAgJ2h0dHBzOi8vaHViLWNsb3VkLmJyb3dzZXJzdGFjay5jb20vd2QvaHViL3Nlc3Npb24nLFxuICAgICAgICBtZXRob2Q6ICdQT1NUJ1xuICAgIH0sXG5cbiAgICBvcGVuVXJsOiBpZCA9PiAoe1xuICAgICAgICB1cmw6ICAgIGBodHRwczovL2h1Yi1jbG91ZC5icm93c2Vyc3RhY2suY29tL3dkL2h1Yi9zZXNzaW9uLyR7aWR9L3VybGAsXG4gICAgICAgIG1ldGhvZDogJ1BPU1QnXG4gICAgfSksXG5cbiAgICBnZXRXaW5kb3dTaXplOiBpZCA9PiAoe1xuICAgICAgICB1cmw6IGBodHRwczovL2h1Yi1jbG91ZC5icm93c2Vyc3RhY2suY29tL3dkL2h1Yi9zZXNzaW9uLyR7aWR9L3dpbmRvdy9jdXJyZW50L3NpemVgXG4gICAgfSksXG5cbiAgICBzZXRXaW5kb3dTaXplOiBpZCA9PiAoe1xuICAgICAgICB1cmw6ICAgIGBodHRwczovL2h1Yi1jbG91ZC5icm93c2Vyc3RhY2suY29tL3dkL2h1Yi9zZXNzaW9uLyR7aWR9L3dpbmRvdy9jdXJyZW50L3NpemVgLFxuICAgICAgICBtZXRob2Q6ICdQT1NUJ1xuICAgIH0pLFxuXG4gICAgbWF4aW1pemVXaW5kb3c6IGlkID0+ICh7XG4gICAgICAgIHVybDogICAgYGh0dHBzOi8vaHViLWNsb3VkLmJyb3dzZXJzdGFjay5jb20vd2QvaHViL3Nlc3Npb24vJHtpZH0vd2luZG93L2N1cnJlbnQvbWF4aW1pemVgLFxuICAgICAgICBtZXRob2Q6ICdQT1NUJ1xuICAgIH0pLFxuXG4gICAgZ2V0VXJsOiBpZCA9PiAoe1xuICAgICAgICB1cmw6IGBodHRwczovL2h1Yi1jbG91ZC5icm93c2Vyc3RhY2suY29tL3dkL2h1Yi9zZXNzaW9uLyR7aWR9L3VybGBcbiAgICB9KSxcblxuICAgIGRlbGV0ZVNlc3Npb246IGlkID0+ICh7XG4gICAgICAgIHVybDogICAgYGh0dHBzOi8vaHViLWNsb3VkLmJyb3dzZXJzdGFjay5jb20vd2QvaHViL3Nlc3Npb24vJHtpZH1gLFxuICAgICAgICBtZXRob2Q6ICdERUxFVEUnXG4gICAgfSksXG5cbiAgICBzY3JlZW5zaG90OiBpZCA9PiAoe1xuICAgICAgICB1cmw6IGBodHRwczovL2h1Yi1jbG91ZC5icm93c2Vyc3RhY2suY29tL3dkL2h1Yi9zZXNzaW9uLyR7aWR9L3NjcmVlbnNob3RgXG4gICAgfSksXG5cbiAgICBnZXRTdGF0dXM6IGlkID0+ICh7XG4gICAgICAgIHVybDogYGh0dHBzOi8vYXBpLmJyb3dzZXJzdGFjay5jb20vYXV0b21hdGUvc2Vzc2lvbnMvJHtpZH0uanNvbmBcbiAgICB9KSxcblxuICAgIHNldFN0YXR1czogaWQgPT4gKHtcbiAgICAgICAgdXJsOiAgICBgaHR0cHM6Ly9hcGkuYnJvd3NlcnN0YWNrLmNvbS9hdXRvbWF0ZS9zZXNzaW9ucy8ke2lkfS5qc29uYCxcbiAgICAgICAgbWV0aG9kOiAnUFVUJ1xuICAgIH0pXG59O1xuXG5cbmZ1bmN0aW9uIHJlcXVlc3RBcGkgKHBhdGgsIHBhcmFtcykge1xuICAgIHJldHVybiByZXF1ZXN0QXBpQmFzZShwYXRoLCBwYXJhbXMpXG4gICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoRVJST1JfTUVTU0FHRVMuUkVNT1RFX0FQSV9SRVFVRVNUX0ZBSUxFRCh7XG4gICAgICAgICAgICAgICAgICAgIHN0YXR1czogICAgICByZXNwb25zZS5zdGF0dXMsXG4gICAgICAgICAgICAgICAgICAgIGFwaVJlc3BvbnNlOiByZXNwb25zZS52YWx1ZSAmJiByZXNwb25zZS52YWx1ZS5tZXNzYWdlIHx8IGluc3BlY3QocmVzcG9uc2UpXG4gICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgICAgIH0pO1xufVxuXG5mdW5jdGlvbiBnZXRDb3JyZWN0ZWRTaXplIChjdXJyZW50Q2xpZW50QXJlYVNpemUsIGN1cnJlbnRXaW5kb3dTaXplLCByZXF1ZXN0ZWRTaXplKSB7XG4gICAgdmFyIGhvcml6b250YWxDaHJvbWUgPSBjdXJyZW50V2luZG93U2l6ZS53aWR0aCAtIGN1cnJlbnRDbGllbnRBcmVhU2l6ZS53aWR0aDtcbiAgICB2YXIgdmVydGljYWxDaHJvbWUgICA9IGN1cnJlbnRXaW5kb3dTaXplLmhlaWdodCAtIGN1cnJlbnRDbGllbnRBcmVhU2l6ZS5oZWlnaHQ7XG5cbiAgICByZXR1cm4ge1xuICAgICAgICB3aWR0aDogIHJlcXVlc3RlZFNpemUud2lkdGggKyBob3Jpem9udGFsQ2hyb21lLFxuICAgICAgICBoZWlnaHQ6IHJlcXVlc3RlZFNpemUuaGVpZ2h0ICsgdmVydGljYWxDaHJvbWVcbiAgICB9O1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBdXRvbWF0ZUJhY2tlbmQgZXh0ZW5kcyBCYXNlQmFja2VuZCB7XG4gICAgY29uc3RydWN0b3IgKC4uLmFyZ3MpIHtcbiAgICAgICAgc3VwZXIoLi4uYXJncyk7XG5cbiAgICAgICAgdGhpcy5zZXNzaW9ucyA9IHt9O1xuICAgIH1cblxuICAgIHN0YXRpYyBfZW5zdXJlU2Vzc2lvbklkIChzZXNzaW9uSW5mbykge1xuICAgICAgICBjb25zdCBzZXNzaW9uRGF0YSAgICAgICAgID0gc2Vzc2lvbkluZm8udmFsdWUgfHwge307XG4gICAgICAgIGNvbnN0IHNlc3Npb25DYXBhYmlsaXRpZXMgPSBzZXNzaW9uRGF0YS5jYXBhYmlsaXRpZXMgfHwge307XG5cbiAgICAgICAgc2Vzc2lvbkluZm8uc2Vzc2lvbklkID0gc2Vzc2lvbkluZm8uc2Vzc2lvbklkIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlc3Npb25EYXRhLnNlc3Npb25JZCB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXNzaW9uRGF0YVsnd2ViZHJpdmVyLnJlbW90ZS5zZXNzaW9uaWQnXSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXNzaW9uQ2FwYWJpbGl0aWVzWyd3ZWJkcml2ZXIucmVtb3RlLnNlc3Npb25pZCddO1xuXG4gICAgICAgIGlmICghc2Vzc2lvbkluZm8uc2Vzc2lvbklkKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoRVJST1JfTUVTU0FHRVMuU0VTU0lPTl9JRF9OT1RfRk9VTkQoe1xuICAgICAgICAgICAgICAgIHNlc3Npb25JbmZvRHVtcDogaW5zcGVjdChzZXNzaW9uSW5mbylcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIF9yZXF1ZXN0U2Vzc2lvblVybCAoaWQpIHtcbiAgICAgICAgdmFyIHNlc3Npb25JbmZvID0gYXdhaXQgcmVxdWVzdEFwaUJhc2UoQlJPV1NFUlNUQUNLX0FQSV9QQVRIUy5nZXRTdGF0dXModGhpcy5zZXNzaW9uc1tpZF0uc2Vzc2lvbklkKSk7XG5cbiAgICAgICAgcmV0dXJuIHNlc3Npb25JbmZvWydhdXRvbWF0aW9uX3Nlc3Npb24nXVsnYnJvd3Nlcl91cmwnXTtcbiAgICB9XG5cbiAgICBhc3luYyBfcmVxdWVzdEN1cnJlbnRXaW5kb3dTaXplIChpZCkge1xuICAgICAgICB2YXIgY3VycmVudFdpbmRvd1NpemVEYXRhID0gYXdhaXQgcmVxdWVzdEFwaShCUk9XU0VSU1RBQ0tfQVBJX1BBVEhTLmdldFdpbmRvd1NpemUodGhpcy5zZXNzaW9uc1tpZF0uc2Vzc2lvbklkKSk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHdpZHRoOiAgY3VycmVudFdpbmRvd1NpemVEYXRhLnZhbHVlLndpZHRoLFxuICAgICAgICAgICAgaGVpZ2h0OiBjdXJyZW50V2luZG93U2l6ZURhdGEudmFsdWUuaGVpZ2h0XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0QnJvd3NlcnNMaXN0ICgpIHtcbiAgICAgICAgdmFyIHBsYXRmb3Jtc0luZm8gPSBhd2FpdCByZXF1ZXN0QXBpQmFzZShCUk9XU0VSU1RBQ0tfQVBJX1BBVEhTLmJyb3dzZXJMaXN0KTtcblxuICAgICAgICByZXR1cm4gcGxhdGZvcm1zSW5mby5yZXZlcnNlKCk7XG4gICAgfVxuXG4gICAgZ2V0U2Vzc2lvblVybCAoaWQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2Vzc2lvbnNbaWRdID8gdGhpcy5zZXNzaW9uc1tpZF0uc2Vzc2lvblVybCA6ICcnO1xuICAgIH1cblxuICAgIGFzeW5jIG9wZW5Ccm93c2VyIChpZCwgcGFnZVVybCwgY2FwYWJpbGl0aWVzKSB7XG4gICAgICAgIHZhciB7IGxvY2FsSWRlbnRpZmllciwgbG9jYWwsIC4uLnJlc3RDYXBhYmlsaXRpZXMgfSA9IGNhcGFiaWxpdGllcztcblxuICAgICAgICBjYXBhYmlsaXRpZXMgPSB7XG4gICAgICAgICAgICAnYnJvd3NlcnN0YWNrLmxvY2FsSWRlbnRpZmllcic6IGxvY2FsSWRlbnRpZmllcixcbiAgICAgICAgICAgICdicm93c2Vyc3RhY2subG9jYWwnOiAgICAgICAgICAgbG9jYWwsXG4gICAgICAgICAgICAuLi5yZXN0Q2FwYWJpbGl0aWVzXG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5zZXNzaW9uc1tpZF0gPSBhd2FpdCByZXF1ZXN0QXBpKEJST1dTRVJTVEFDS19BUElfUEFUSFMubmV3U2Vzc2lvbiwge1xuICAgICAgICAgICAgYm9keTogeyBkZXNpcmVkQ2FwYWJpbGl0aWVzOiBjYXBhYmlsaXRpZXMgfSxcblxuICAgICAgICAgICAgZXhlY3V0ZUltbWVkaWF0ZWx5OiB0cnVlXG4gICAgICAgIH0pO1xuXG4gICAgICAgIEF1dG9tYXRlQmFja2VuZC5fZW5zdXJlU2Vzc2lvbklkKHRoaXMuc2Vzc2lvbnNbaWRdKTtcblxuICAgICAgICB0aGlzLnNlc3Npb25zW2lkXS5zZXNzaW9uVXJsID0gYXdhaXQgdGhpcy5fcmVxdWVzdFNlc3Npb25VcmwoaWQpO1xuXG4gICAgICAgIHZhciBzZXNzaW9uSWQgPSB0aGlzLnNlc3Npb25zW2lkXS5zZXNzaW9uSWQ7XG5cbiAgICAgICAgdGhpcy5zZXNzaW9uc1tpZF0uaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiByZXF1ZXN0QXBpKEJST1dTRVJTVEFDS19BUElfUEFUSFMuZ2V0VXJsKHNlc3Npb25JZCksIHsgZXhlY3V0ZUltbWVkaWF0ZWx5OiB0cnVlIH0pLCBBUElfUE9MTElOR19JTlRFUlZBTCk7XG5cbiAgICAgICAgYXdhaXQgcmVxdWVzdEFwaShCUk9XU0VSU1RBQ0tfQVBJX1BBVEhTLm9wZW5Vcmwoc2Vzc2lvbklkKSwgeyBib2R5OiB7IHVybDogcGFnZVVybCB9IH0pO1xuICAgIH1cblxuICAgIGFzeW5jIGNsb3NlQnJvd3NlciAoaWQpIHtcbiAgICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMuc2Vzc2lvbnNbaWRdO1xuXG4gICAgICAgIGlmICghc2Vzc2lvbilcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBjbGVhckludGVydmFsKHNlc3Npb24uaW50ZXJ2YWwpO1xuXG4gICAgICAgIGRlbGV0ZSB0aGlzLnNlc3Npb25zW2lkXTtcblxuICAgICAgICAvLyBEZWxldGUgc2Vzc2lvbiB3aG9zZSBzZXNzaW9uSWQgaXMgY3JlYXRlZFxuICAgICAgICBpZiAoc2Vzc2lvbi5zZXNzaW9uSWQgJiYgc2Vzc2lvbi5zZXNzaW9uSWQgIT09ICcnKVxuICAgICAgICAgICAgYXdhaXQgcmVxdWVzdEFwaShCUk9XU0VSU1RBQ0tfQVBJX1BBVEhTLmRlbGV0ZVNlc3Npb24oc2Vzc2lvbi5zZXNzaW9uSWQpKTtcbiAgICB9XG5cbiAgICBhc3luYyB0YWtlU2NyZWVuc2hvdCAoaWQsIHNjcmVlbnNob3RQYXRoKSB7XG4gICAgICAgIHZhciBiYXNlNjREYXRhID0gYXdhaXQgcmVxdWVzdEFwaShCUk9XU0VSU1RBQ0tfQVBJX1BBVEhTLnNjcmVlbnNob3QodGhpcy5zZXNzaW9uc1tpZF0uc2Vzc2lvbklkKSk7XG4gICAgICAgIHZhciBidWZmZXIgICAgID0gQnVmZmVyLmZyb20oYmFzZTY0RGF0YS52YWx1ZSwgJ2Jhc2U2NCcpO1xuXG4gICAgICAgIGNvbnN0IGltYWdlID0gYXdhaXQgamltcC5yZWFkKGJ1ZmZlcik7XG5cbiAgICAgICAgYXdhaXQgaW1hZ2Uud3JpdGUoc2NyZWVuc2hvdFBhdGgpO1xuICAgIH1cblxuICAgIGFzeW5jIHJlc2l6ZVdpbmRvdyAoaWQsIHdpZHRoLCBoZWlnaHQsIGN1cnJlbnRXaWR0aCwgY3VycmVudEhlaWdodCkge1xuICAgICAgICB2YXIgc2Vzc2lvbklkICAgICAgICAgICAgID0gdGhpcy5zZXNzaW9uc1tpZF0uc2Vzc2lvbklkO1xuICAgICAgICB2YXIgY3VycmVudFdpbmRvd1NpemUgICAgID0gYXdhaXQgdGhpcy5fcmVxdWVzdEN1cnJlbnRXaW5kb3dTaXplKGlkKTtcbiAgICAgICAgdmFyIGN1cnJlbnRDbGllbnRBcmVhU2l6ZSA9IHsgd2lkdGg6IGN1cnJlbnRXaWR0aCwgaGVpZ2h0OiBjdXJyZW50SGVpZ2h0IH07XG4gICAgICAgIHZhciByZXF1ZXN0ZWRTaXplICAgICAgICAgPSB7IHdpZHRoLCBoZWlnaHQgfTtcbiAgICAgICAgdmFyIGNvcnJlY3RlZFNpemUgICAgICAgICA9IGdldENvcnJlY3RlZFNpemUoY3VycmVudENsaWVudEFyZWFTaXplLCBjdXJyZW50V2luZG93U2l6ZSwgcmVxdWVzdGVkU2l6ZSk7XG5cbiAgICAgICAgYXdhaXQgcmVxdWVzdEFwaShCUk9XU0VSU1RBQ0tfQVBJX1BBVEhTLnNldFdpbmRvd1NpemUoc2Vzc2lvbklkKSwgeyBib2R5OiBjb3JyZWN0ZWRTaXplIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIG1heGltaXplV2luZG93IChpZCkge1xuICAgICAgICBhd2FpdCByZXF1ZXN0QXBpKEJST1dTRVJTVEFDS19BUElfUEFUSFMubWF4aW1pemVXaW5kb3codGhpcy5zZXNzaW9uc1tpZF0uc2Vzc2lvbklkKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgcmVwb3J0Sm9iUmVzdWx0IChpZCwgam9iUmVzdWx0LCBqb2JEYXRhLCBwb3NzaWJsZVJlc3VsdHMpIHtcbiAgICAgICAgdmFyIHNlc3Npb25JZCA9IHRoaXMuc2Vzc2lvbnNbaWRdLnNlc3Npb25JZDtcbiAgICAgICAgdmFyIGpvYlN0YXR1cyA9IGNyZWF0ZUJyb3dzZXJzdGFja1N0YXR1cyhqb2JSZXN1bHQsIGpvYkRhdGEsIHBvc3NpYmxlUmVzdWx0cyk7XG5cbiAgICAgICAgYXdhaXQgcmVxdWVzdEFwaUJhc2UoQlJPV1NFUlNUQUNLX0FQSV9QQVRIUy5zZXRTdGF0dXMoc2Vzc2lvbklkKSwgeyBib2R5OiBqb2JTdGF0dXMgfSk7XG4gICAgfVxufVxuIl19